---
services:
  guacd:
    image: guacamole/guacd:1.6.0
    container_name: guacd
    networks: [guacnet]

  mysql-guacamole:
    image: mysql:8.0
    container_name: guacamoledb
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_ROOT_PASSWORD}
      - MYSQL_DATABASE=${MYSQL_DATABASE}
      - MYSQL_USER=${MYSQL_USER}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD}
    volumes:
      - /home/notolac/guacamole-mysql:/var/lib/mysql
    networks: [guacnet]

  guacamole:
    image: guacamole/guacamole:1.6.0
    container_name: guacamole-oficial
    depends_on:
      guacd:
        condition: service_started
      mysql-guacamole:
        condition: service_started
    environment:
      MYSQL_HOSTNAME: "mysql-guacamole"
      MYSQL_PORT: "3306"
      MYSQL_DATABASE: ${MYSQL_DATABASE}
      MYSQL_USER: ${MYSQL_USER}
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      GUACD_HOSTNAME: "guacd"
      GUACD_PORT: "4822"
      TOTP_ENABLED: "true"
    networks:
      - guacnet
      - traefik-stack
    labels:
      - "traefik.enable=true"

      # Router principal: sirve /guacamole/*
      - "traefik.http.routers.guac.rule=Host(`ndp.notolac.org`) && PathPrefix(`/guacamole`)"
      - "traefik.http.routers.guac.entrypoints=websecure"
      - "traefik.http.routers.guac.tls=true"
      - "traefik.http.routers.guac.tls.certresolver=cloudflare"
      - "traefik.http.routers.guac.service=guac-svc"

      # Router raíz -> /guacamole/
      - "traefik.http.routers.guac-root.rule=Host(`ndp.notolac.org`) && Path(`/`)"
      - "traefik.http.routers.guac-root.entrypoints=websecure"
      - "traefik.http.routers.guac-root.tls=true"
      - "traefik.http.routers.guac-root.tls.certresolver=cloudflare"
      - "traefik.http.routers.guac-root.middlewares=guac-redirect"
      - "traefik.http.routers.guac-root.service=noop@internal" 

      # Middleware: redirección /
      - "traefik.http.middlewares.guac-redirect.redirectregex.regex=^/$"
      - "traefik.http.middlewares.guac-redirect.redirectregex.replacement=/guacamole/"
      - "traefik.http.middlewares.guac-redirect.redirectregex.permanent=true"

      # Service/backend
      - "traefik.http.services.guac-svc.loadbalancer.server.port=8080"
      - "traefik.http.services.guac-svc.loadbalancer.passHostHeader=true"

networks:
  guacnet:
    driver: bridge
  traefik-stack:
    external: true
